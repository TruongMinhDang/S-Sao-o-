rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* =========================
       Helpers & Role predicates
       ========================= */
    function isAuth() {
      return request.auth != null;
    }

    function hasRole(r) {
      return isAuth() && request.auth.token.role != null && request.auth.token.role == r;
    }

    function isAdmin() { return hasRole('admin'); }
    function isProctor() { return hasRole('giam_thi'); }
    function isHomeroom() { return hasRole('homeroom_teacher'); }
    function isReadOnlyBoss() {
      return hasRole('hieu_truong') || hasRole('pho_hieu_truong') || hasRole('nhan_vien_cntt');
    }

    function homeroomCanView(resourceData) {
      return isHomeroom()
        && (
            (resourceData.classId != null
              && request.auth.token.homeroomClassId != null
              && resourceData.classId == request.auth.token.homeroomClassId)
          || (resourceData.gradeId != null
              && request.auth.token.homeroomGradeId != null
              && resourceData.gradeId == request.auth.token.homeroomGradeId)
        );
    }

    function canRead(resourceData) {
      return isAdmin()
          || isReadOnlyBoss()
          || isProctor()
          || homeroomCanView(resourceData);
    }

    /* =========
       OVERRIDE
       ========= */
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    /* ========
       USERS
       ======== */
    match /users/{uid} {
      allow list: if isAdmin();
      allow get: if isAuth() && request.auth.uid == uid;
      allow create: if isAuth() && request.auth.uid == uid;
      allow update: if isAuth()
                    && request.auth.uid == uid
                    && !('roles' in request.resource.data.diff(resource.data).changedKeys())
                    && !('claims' in request.resource.data.diff(resource.data).changedKeys());
      allow delete: if false;
    }

    /* ==========
       CLASSES
       ========== */
    match /classes/{classId} {
      allow read: if isAuth();
      allow write: if false;
    }

    /* ==========
       STUDENTS
       ========== */
    match /students/{studentId} {
      allow read: if isAuth() && canRead(resource.data);
      allow write: if false;
    }

    /* =========
       RECORDS
       ========= */
    match /records/{recordId} {
      // UPDATED: Allow all authenticated teachers/staff to read for leaderboard purposes
      allow read: if isAuth() && (isReadOnlyBoss() || isProctor() || isHomeroom());
      allow create: if isAuth()
                    && isProctor()
                    && request.resource.data.classId is string
                    && request.resource.data.gradeId is string;
      allow update, delete: if isAuth() && isProctor();
    }

    /* ===============
       WEEKLY SCORES
       =============== */
    match /weeklyScores/{scoreId} {
      // UPDATED: Allow all authenticated teachers/staff to read for leaderboard purposes
      allow read: if isAuth() && (isReadOnlyBoss() || isProctor() || isHomeroom());
      allow write: if false;
    }

    /* ======
       RULES
       ====== */
    match /rules/{id} {
      allow read: if isAuth();
      allow write: if false;
    }
  }
}