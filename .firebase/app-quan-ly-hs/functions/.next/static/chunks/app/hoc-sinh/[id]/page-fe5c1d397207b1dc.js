(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2794],{26302:function(e,s,t){Promise.resolve().then(t.bind(t,77878))},77878:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return A}});var i=t(27573),l=t(7653),n=t(21897),r=t(16851),c=t(72196),d=t(50188),a=t(50466),h=t(29147);let o=l.forwardRef((e,s)=>{let{className:t,...l}=e;return(0,i.jsx)("textarea",{className:(0,h.cn)("flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",t),ref:s,...l})});o.displayName="Textarea";var x=t(88146),m=t(61883),u=t(57790),j=t(29958),f=t(35486),g=t(50896),p=t(48266),N=t(57895),v=t(95192),b=t(36772),y=t(40210),S=t(55351),C=t(53847),w=t(76553);let K=e=>e&&e.startsWith("class_")?e.substring(6).replace(/_/g,"/"):e,T=(e,s)=>{if(!e)return"N/A";let t=s.find(s=>s.code===e);return t?t.description:e},k=["#FF8042","#FFBB28","#00C49F","#0088FE","#A569BD","#F1948A"];function A(e){let{params:s}=e,{user:t,isSuperAdmin:h,isViewerAdmin:A,isHomeroomTeacher:F,userProfile:Z}=(0,w.a)(),[D,L]=(0,l.useState)(null),[M,O]=(0,l.useState)([]),[I,P]=(0,l.useState)([]),[R,_]=(0,l.useState)([]),[B,E]=(0,l.useState)(""),[J,Y]=(0,l.useState)(!1),[z,H]=(0,l.useState)(!0),[V,q]=(0,l.useState)(null),X=s.id;(0,l.useEffect)(()=>{if(!X)return;(0,n.PL)((0,n.hJ)(r.db,"rules")).then(e=>{_(e.docs.map(e=>({id:e.id,...e.data()})))});let e=(0,n.JU)(r.db,"students",X),s=(0,n.cf)(e,e=>{if(e.exists()){var s,t,i;let l=e.data();L({id:e.id,studentId:null!==(s=l.schoolId)&&void 0!==s?s:"N/A",name:null!==(t=l.fullName)&&void 0!==t?t:"Kh\xf4ng c\xf3 t\xean",class:null!==(i=l.classRef)&&void 0!==i?i:"Chưa c\xf3 lớp"}),q(null)}else q("Kh\xf4ng t\xecm thấy th\xf4ng tin học sinh."),L(null);H(!1)},e=>{console.error("Lỗi Firestore (student):",e),q("Kh\xf4ng thể tải dữ liệu học sinh: ".concat(e.message)),H(!1)}),t=(0,n.IO)((0,n.hJ)(r.db,"students",X,"comments"),(0,n.Xo)("timestamp","desc")),i=(0,n.cf)(t,e=>{P(e.docs.map(e=>({id:e.id,...e.data()})))},e=>console.error("Lỗi Firestore (comments):",e));return()=>{s(),i()}},[X]),(0,l.useEffect)(()=>{if(!D||"N/A"===D.studentId){O([]);return}let e=(0,n.IO)((0,n.hJ)(r.db,"records"),(0,n.ar)("studentId","==",D.studentId),(0,n.Xo)("recordDate","desc")),s=(0,n.cf)(e,e=>{O(e.docs.map(e=>({id:e.id,...e.data()})))},e=>{console.error("Lỗi Firestore (violations):",e),q("Kh\xf4ng thể tải lịch sử vi phạm.")});return()=>{s()}},[D]);let $=(0,l.useMemo)(()=>{if(!D||!Z)return!1;if(h||A)return!0;if(F&&D.class){var e;return null===(e=Z.assignedClasses)||void 0===e?void 0:e.includes(D.class)}return!1},[D,Z,h,A,F]),G=(0,l.useMemo)(()=>{let e=M.filter(e=>"merit"===e.type).reduce((e,s)=>e+(s.pointsApplied||0),0),s=M.filter(e=>"demerit"===e.type).reduce((e,s)=>e+Math.abs(s.pointsApplied||0),0);return{totalPlusPoints:e,totalMinusPoints:s,finalScore:1e3+e-s}},[M]),Q=[{name:"Điểm","Điểm cộng":G.totalPlusPoints,"Điểm trừ":G.totalMinusPoints}],U=(0,l.useMemo)(()=>0===M.length||0===R.length?[]:Object.entries(M.filter(e=>"demerit"===e.type&&e.ruleRef).reduce((e,s)=>{let t=T(s.ruleRef,R);return e[t]=(e[t]||0)+1,e},{})).map(e=>{let[s,t]=e;return{name:s,value:t}}),[M,R]),W=async()=>{if(B.trim()&&t&&D){Y(!0);try{await (0,n.ET)((0,n.hJ)(r.db,"students",D.id,"comments"),{content:B,authorId:t.uid,authorName:(null==Z?void 0:Z.displayName)||"Kh\xf4ng r\xf5",timestamp:(0,n.Bt)()}),E("")}catch(e){console.error("Lỗi khi gửi nhận x\xe9t: ",e),alert("Đ\xe3 c\xf3 lỗi xảy ra khi gửi nhận x\xe9t của bạn.")}finally{Y(!1)}}};return z?(0,i.jsx)("div",{className:"h-24 text-center flex items-center justify-center",children:"Đang tải dữ liệu..."}):V?(0,i.jsx)("div",{className:"h-24 text-center flex items-center justify-center text-red-500",children:V}):D?$?(0,i.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,i.jsxs)("div",{className:"flex items-center gap-4",children:[(0,i.jsx)(a.z,{asChild:!0,variant:"outline",size:"icon",children:(0,i.jsx)(x.default,{href:"/hoc-sinh",children:(0,i.jsx)(m.Z,{className:"h-4 w-4"})})}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h1",{className:"text-2xl font-bold tracking-tight",children:"Chi Tiết Học Sinh"}),(0,i.jsx)("p",{className:"text-muted-foreground",children:"Th\xf4ng tin v\xe0 lịch sử vi phạm của học sinh."})]})]}),(0,i.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[(0,i.jsxs)("div",{className:"lg:col-span-1 flex flex-col gap-4",children:[(0,i.jsxs)(c.Zb,{children:[(0,i.jsxs)(c.Ol,{children:[(0,i.jsx)(c.ll,{children:D.name}),(0,i.jsxs)(c.SZ,{children:["M\xe3 số: ",D.studentId]})]}),(0,i.jsx)(c.aY,{children:(0,i.jsx)(d.iA,{className:"bg-card",children:(0,i.jsxs)(d.RM,{children:[(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.pj,{className:"font-medium",children:"Họ v\xe0 T\xean"}),(0,i.jsx)(d.pj,{children:D.name})]}),(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.pj,{className:"font-medium",children:"Lớp"}),(0,i.jsx)(d.pj,{children:K(D.class)})]}),(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.pj,{className:"font-medium",children:"Tổng điểm cộng"}),(0,i.jsxs)(d.pj,{className:"text-green-600 font-semibold",children:["+",G.totalPlusPoints]})]}),(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.pj,{className:"font-medium",children:"Tổng điểm trừ"}),(0,i.jsxs)(d.pj,{className:"text-red-600 font-semibold",children:["-",G.totalMinusPoints]})]}),(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.pj,{className:"font-medium",children:"Điểm tổng kết"}),(0,i.jsx)(d.pj,{className:"font-bold",children:G.finalScore})]})]})})})]}),(0,i.jsxs)(c.Zb,{children:[(0,i.jsx)(c.Ol,{children:(0,i.jsx)(c.ll,{children:"Nhận x\xe9t của gi\xe1o vi\xean"})}),(0,i.jsxs)(c.aY,{className:"space-y-4",children:[(0,i.jsx)("div",{className:"space-y-3 max-h-60 overflow-y-auto pr-2",children:I.length>0?I.map(e=>{var s;return(0,i.jsxs)("div",{className:"border-l-2 pl-3",children:[(0,i.jsx)("p",{className:"text-sm",children:e.content}),(0,i.jsxs)("p",{className:"text-xs text-muted-foreground",children:["- ",e.authorName," (",new Date((null===(s=e.timestamp)||void 0===s?void 0:s.seconds)*1e3).toLocaleDateString("vi-VN"),")"]})]},e.id)}):(0,i.jsx)("p",{className:"text-sm text-muted-foreground",children:"Chưa c\xf3 nhận x\xe9t n\xe0o."})}),(h||F)&&(0,i.jsxs)("div",{className:"space-y-2 pt-4 border-t",children:[(0,i.jsx)(o,{placeholder:"Th\xeam nhận x\xe9t mới...",value:B,onChange:e=>E(e.target.value),disabled:J}),(0,i.jsx)(a.z,{className:"w-full",onClick:W,disabled:J||!B.trim(),children:J?"Đang gửi...":"Gửi nhận x\xe9t"})]})]})]})]}),(0,i.jsxs)("div",{className:"lg:col-span-2 flex flex-col gap-4",children:[(0,i.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,i.jsxs)(c.Zb,{children:[(0,i.jsxs)(c.Ol,{children:[(0,i.jsx)(c.ll,{children:"Biểu đồ điểm"}),(0,i.jsx)(c.SZ,{children:"Tổng điểm cộng v\xe0 điểm trừ"})]}),(0,i.jsx)(c.aY,{children:(0,i.jsx)(u.h,{width:"100%",height:200,children:(0,i.jsxs)(j.v,{data:Q,children:[(0,i.jsx)(f.q,{strokeDasharray:"3 3"}),(0,i.jsx)(g.K,{dataKey:"name"}),(0,i.jsx)(p.B,{}),(0,i.jsx)(N.u,{}),(0,i.jsx)(v.D,{}),(0,i.jsx)(b.$,{dataKey:"Điểm cộng",fill:"#16a34a"}),(0,i.jsx)(b.$,{dataKey:"Điểm trừ",fill:"#dc2626"})]})})})]}),(0,i.jsxs)(c.Zb,{children:[(0,i.jsxs)(c.Ol,{children:[(0,i.jsx)(c.ll,{children:"Thống k\xea vi phạm"}),(0,i.jsx)(c.SZ,{children:"Tỉ lệ c\xe1c lỗi thường gặp"})]}),(0,i.jsx)(c.aY,{children:(0,i.jsx)(u.h,{width:"100%",height:200,children:U.length>0?(0,i.jsxs)(y.u,{children:[(0,i.jsx)(S.b,{data:U,cx:"50%",cy:"50%",labelLine:!1,outerRadius:80,fill:"#8884d8",dataKey:"value",label:e=>{let{name:s,percent:t}=e;return"".concat(s," ").concat((100*t).toFixed(0),"%")},children:U.map((e,s)=>(0,i.jsx)(C.b,{fill:k[s%k.length]},"cell-".concat(s)))}),(0,i.jsx)(N.u,{formatter:(e,s)=>["".concat(e," lần"),s]})]}):(0,i.jsx)("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Kh\xf4ng c\xf3 dữ liệu vi phạm."})})})]})]}),(0,i.jsxs)(c.Zb,{children:[(0,i.jsxs)(c.Ol,{children:[(0,i.jsx)(c.ll,{children:"Lịch sử Vi phạm & Khen thưởng"}),(0,i.jsx)(c.SZ,{children:"To\xe0n bộ c\xe1c mục được ghi nhận cho học sinh n\xe0y."})]}),(0,i.jsx)(c.aY,{children:(0,i.jsx)("div",{className:"overflow-auto rounded-md border",style:{maxHeight:"600px"},children:(0,i.jsxs)(d.iA,{children:[(0,i.jsx)(d.xD,{children:(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.ss,{children:"Thời gian"}),(0,i.jsx)(d.ss,{children:"Nội dung"}),(0,i.jsx)(d.ss,{className:"text-right",children:"Điểm"})]})}),(0,i.jsx)(d.RM,{children:M.length>0?M.map(e=>(0,i.jsxs)(d.SC,{children:[(0,i.jsx)(d.pj,{className:"text-sm",children:e.recordDate?new Date(1e3*e.recordDate.seconds).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"}):"N/A"}),(0,i.jsx)(d.pj,{children:T(e.ruleRef,R)}),(0,i.jsxs)(d.pj,{className:"text-right font-semibold ".concat("merit"===e.type?"text-green-600":"text-red-600"),children:["merit"===e.type?"+":"-",Math.abs(e.pointsApplied||0)]})]},e.id)):(0,i.jsx)(d.SC,{children:(0,i.jsx)(d.pj,{colSpan:3,className:"h-24 text-center",children:"Kh\xf4ng c\xf3 dữ liệu."})})})]})})})]})]})]})]}):(0,i.jsxs)("div",{className:"text-center p-8",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold",children:"Truy cập bị từ chối"}),(0,i.jsx)("p",{children:"Bạn kh\xf4ng c\xf3 quyền xem th\xf4ng tin của học sinh n\xe0y."}),(0,i.jsx)(a.z,{asChild:!0,variant:"outline",className:"mt-4",children:(0,i.jsxs)(x.default,{href:"/hoc-sinh",children:[(0,i.jsx)(m.Z,{className:"mr-2 h-4 w-4"}),"Quay lại"]})})]}):(0,i.jsx)("div",{className:"h-24 text-center flex items-center justify-center text-red-500",children:"Kh\xf4ng t\xecm thấy học sinh."})}}},function(e){e.O(0,[6415,5117,2997,1661,6951,8146,8534,2342,6807,1293,1528,1744],function(){return e(e.s=26302)}),_N_E=e.O()}]);