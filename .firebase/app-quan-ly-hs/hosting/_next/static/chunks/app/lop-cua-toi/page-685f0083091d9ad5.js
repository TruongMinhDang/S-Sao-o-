(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6955],{62382:function(e,t,s){Promise.resolve().then(s.bind(s,98962))},98962:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return M}});var l=s(27573),n=s(7653),a=s(88146),r=s(16851),i=s(21897),c=s(50188),d=s(50466),o=s(76553),u=s(72196),m=s(57790),h=s(57364),x=s(35486),p=s(50896),f=s(48266),j=s(57895),v=s(45168);function g(e){let{items:t,placeholder:s,value:a,onChange:r}=e,[i,c]=(0,n.useState)(!1),[d,o]=(0,n.useState)(""),u=(0,n.useRef)(null),m=(0,n.useRef)(null),h=(0,n.useMemo)(()=>{if(!d.trim())return t;let e=d.toLowerCase();return t.filter(t=>{var s,l;return t.label.toLowerCase().includes(e)||null!==(l=null===(s=t.sub)||void 0===s?void 0:s.toLowerCase().includes(e))&&void 0!==l&&l})},[t,d]),x=(0,n.useMemo)(()=>{var e;return(null===(e=t.find(e=>e.value===a))||void 0===e?void 0:e.label)||""},[t,a]);return(0,n.useEffect)(()=>{i&&u.current&&u.current.focus()},[i]),(0,n.useEffect)(()=>{function e(e){m.current&&!m.current.contains(e.target)&&c(!1)}return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[m]),(0,l.jsxs)("div",{className:"relative",ref:m,children:[(0,l.jsxs)("button",{type:"button",className:"w-full border rounded px-3 py-2 text-left bg-popover text-popover-foreground text-base h-[42px] flex items-center",onClick:()=>c(e=>!e),children:[(0,l.jsx)("span",{className:"truncate block",children:x||s}),(0,l.jsx)("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 opacity-60",children:"▾"})]}),i&&(0,l.jsxs)("div",{className:"absolute z-50 mt-1 w-full bg-popover border rounded shadow-lg max-h-72 overflow-auto",children:[(0,l.jsx)("div",{className:"sticky top-0 bg-popover p-2 border-b",children:(0,l.jsx)("input",{ref:u,value:d,onChange:e=>o(e.target.value),placeholder:"T\xecm kiếm nhanh...",className:"w-full border rounded px-3 py-2 text-base"})}),0===h.length?(0,l.jsx)("div",{className:"p-3 text-muted-foreground",children:"Kh\xf4ng c\xf3 kết quả"}):h.map(e=>(0,l.jsxs)("div",{className:"px-4 py-2 cursor-pointer hover:bg-accent text-popover-foreground",onClick:()=>{r(e.value),c(!1),o("")},children:[(0,l.jsx)("div",{className:"font-medium text-base",children:e.label}),e.sub&&(0,l.jsx)("div",{className:"text-sm text-muted-foreground",children:e.sub})]},e.value))]})]})}let b=()=>{let e=new Date;return new Date(8>e.getMonth()?e.getFullYear()-1:e.getFullYear(),8,8)},N=()=>{let e=b(),t=[];for(let s=1;s<=35;s++){let l=new Date(e.getTime()+(s-1)*6048e5),n=new Date(l.getTime()+5184e5),a=e=>e<10?"0".concat(e):"".concat(e);t.push({value:String(s),label:"Tuần ".concat(s," (").concat(a(l.getDate()),"/").concat(a(l.getMonth()+1)," - ").concat(a(n.getDate()),"/").concat(a(n.getMonth()+1),")")})}return t},w=e=>{let t=e instanceof Date?e:(null==e?void 0:e.toDate)?e.toDate():new Date(e);if(isNaN(t.getTime()))return 1;let s=b();return Math.max(1,Math.min(35,Math.floor(Math.floor((t.setHours(0,0,0,0)-s.setHours(0,0,0,0))/864e5)/7)+1))},y=(e,t)=>{if(!e)return"N/A";let s=t.find(t=>t.code===e);return s?s.description:e},C=(e,t)=>{if(!e)return"N/A";let s=t.find(t=>t.id===e);return s?s.displayName:e};function M(){let{user:e,isAdmin:t,isHomeroomTeacher:s}=(0,o.a)(),[b,M]=(0,n.useState)([]),[k,S]=(0,n.useState)([]),[D,T]=(0,n.useState)([]),[A,L]=(0,n.useState)([]),[E,O]=(0,n.useState)([]),[_,R]=(0,n.useState)(!0),[P,Z]=(0,n.useState)(null),I=(0,n.useMemo)(N,[]),[K,Y]=(0,n.useState)(String(w(new Date))),[H,F]=(0,n.useState)("all"),[z,B]=(0,n.useState)("all");(0,n.useEffect)(()=>{R(!0),(async()=>{try{let[t,l,n]=await Promise.all([(0,i.PL)((0,i.hJ)(r.db,"rules")),(0,i.PL)((0,i.hJ)(r.db,"users")),(0,i.PL)((0,i.hJ)(r.db,"classes"))]);L(t.docs.map(e=>({id:e.id,...e.data()}))),O(l.docs.map(e=>({id:e.id,...e.data()})));let a=new Intl.Collator("vi",{numeric:!0,sensitivity:"base"}),c=n.docs.map(e=>({id:e.id,...e.data()}));if(c.sort((e,t)=>a.compare(e.name,t.name)),M(c),s&&(null==e?void 0:e.uid)){let t=c.find(t=>t.homeroomTeacherRef===e.uid);t&&B(t.id)}}catch(e){Z("Lỗi tải dữ liệu: ".concat(e.message))}finally{R(!1)}})()},[e,s]),(0,n.useEffect)(()=>{if("all"===z){S([]),R(!1);return}R(!0),Z(null);let e=(0,i.IO)((0,i.hJ)(r.db,"records"),(0,i.ar)("classRef","==",z),(0,i.ar)("week","==",Number(K))),t=(0,i.cf)(e,e=>{S(e.docs.map(e=>({id:e.id,...e.data()})).sort((e,t)=>{var s,l;return((null===(s=t.recordDate)||void 0===s?void 0:s.seconds)||0)-((null===(l=e.recordDate)||void 0===l?void 0:l.seconds)||0)})),R(!1)},e=>{Z("Kh\xf4ng thể tải dữ liệu vi phạm. Lỗi: ".concat(e.message)),R(!1)}),s=(0,i.IO)((0,i.hJ)(r.db,"weekly_reports")),l=(0,i.cf)(s,e=>{T(e.docs.map(e=>({id:e.id,...e.data()})))});return()=>{t(),l()}},[z,K]);let J=(0,n.useMemo)(()=>[{value:"all",label:"Tất cả c\xe1c khối"},...Array.from(new Set(b.map(e=>e.gradeId).filter(Boolean))).sort().map(e=>{let t=String(e).split("_")[1]||e;return{value:e,label:"Khối ".concat(t)}})],[b]),q=(0,n.useMemo)(()=>{let e=b;return t||"all"===H||(e=b.filter(e=>e.gradeId===H)),[{value:"all",label:"-- Chọn lớp --"},...e.map(e=>({value:e.id,label:e.name}))]},[H,b,t]),V=(0,n.useMemo)(()=>b.find(e=>e.id===z),[z,b]),Q=(0,n.useMemo)(()=>{let e=k.filter(e=>"merit"===e.type).reduce((e,t)=>e+(Number(t.pointsApplied)||0),0),t=k.filter(e=>"demerit"===e.type).reduce((e,t)=>e+Math.abs(Number(t.pointsApplied)||0),0),s=k.reduce((e,t)=>(t.ruleRef&&"demerit"===t.type&&(e[t.ruleRef]=(e[t.ruleRef]||0)+1),e),{});return{totalMerit:e,totalDemerit:t,totalPoints:1e3+e-t,commonError:y(Object.keys(s).reduce((e,t)=>s[e]>s[t]?e:t,"Kh\xf4ng c\xf3"),A)}},[k,A]),W=(0,n.useMemo)(()=>{if(!V||0===D.length)return[];let e=Array.from({length:35},(e,t)=>t+1).map(e=>{var t;let s=D.find(t=>t.id==="week_".concat(e)),l=null==s?void 0:null===(t=s.scores)||void 0===t?void 0:t[V.name];return{week:e,points:"number"==typeof l?l:null}}),t=1e3;return e.map(e=>{var s;return null!==e.points&&(t=e.points),{...e,points:null!==(s=e.points)&&void 0!==s?s:t}})},[V,D]),G=(0,n.useMemo)(()=>{let e=W.map(e=>e.points).filter(e=>null!==e);if(!e.length)return{min:800,max:1200};let t=Math.min(...e),s=Math.max(...e),l=Math.max(20,Math.round((s-t)*.1));return{min:t-l,max:s+l}},[W]);return(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)(u.Zb,{children:[(0,l.jsx)(u.Ol,{children:(0,l.jsxs)("div",{className:"flex flex-col md:flex-row justify-between md:items-center gap-4",children:[(0,l.jsxs)("div",{className:"flex items-center gap-4",children:[(0,l.jsx)("img",{src:"https://firebasestorage.googleapis.com/v0/b/app-quan-ly-hs.firebasestorage.app/o/Icon%2Ficon%20bi%C3%AA%CC%89u%20%C4%91%C3%B4%CC%80.gif?alt=media&token=efb96cab-ddfa-4169-892f-27073792ed36",alt:"Biểu đồ icon",className:"w-10 h-10"}),(0,l.jsxs)("div",{children:[(0,l.jsx)(u.ll,{className:"text-2xl",children:"Tổng Quan Lớp Học"}),(0,l.jsx)(u.SZ,{children:"Theo d\xf5i điểm số v\xe0 vi phạm qua từng tuần."})]})]}),(0,l.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4",children:[!t&&(0,l.jsx)("div",{className:"w-full sm:w-[180px]",children:(0,l.jsx)(g,{items:J,placeholder:"Chọn khối",value:H,onChange:F})}),(0,l.jsx)("div",{className:"w-full ".concat(t?"sm:w-[240px]":"sm:w-[180px]"),children:(0,l.jsx)(g,{items:q,placeholder:"-- Chọn lớp --",value:z,onChange:B})}),(0,l.jsx)("div",{className:"w-full sm:w-[280px]",children:(0,l.jsx)(g,{items:I,placeholder:"Chọn tuần",value:K,onChange:Y})})]})]})}),"all"!==z&&(0,l.jsx)(u.aY,{className:"space-y-6",children:_?(0,l.jsx)("div",{className:"text-center py-10",children:"Đang tải dữ liệu..."}):P?(0,l.jsx)("div",{className:"text-center py-10 text-red-500",children:P}):(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[(0,l.jsxs)(u.Zb,{children:[(0,l.jsx)(u.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:(0,l.jsx)(u.ll,{className:"text-sm font-medium",children:"Tổng điểm tuần"})}),(0,l.jsx)(u.aY,{children:(0,l.jsx)("div",{className:"text-2xl font-bold ".concat(Q.totalPoints>=1e3?"text-green-600":"text-red-600"),children:Q.totalPoints})})]}),(0,l.jsxs)(u.Zb,{children:[(0,l.jsx)(u.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:(0,l.jsx)(u.ll,{className:"text-sm font-medium",children:"Điểm cộng"})}),(0,l.jsx)(u.aY,{children:(0,l.jsxs)("div",{className:"text-2xl font-bold text-green-600",children:["+",Q.totalMerit]})})]}),(0,l.jsxs)(u.Zb,{children:[(0,l.jsx)(u.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:(0,l.jsx)(u.ll,{className:"text-sm font-medium",children:"Điểm trừ"})}),(0,l.jsx)(u.aY,{children:(0,l.jsxs)("div",{className:"text-2xl font-bold text-red-600",children:["-",Q.totalDemerit]})})]}),(0,l.jsxs)(u.Zb,{children:[(0,l.jsx)(u.Ol,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:(0,l.jsx)(u.ll,{className:"text-sm font-medium",children:"Lỗi phổ biến"})}),(0,l.jsx)(u.aY,{children:(0,l.jsx)("div",{className:"text-md font-bold truncate",title:Q.commonError,children:Q.commonError})})]})]}),(0,l.jsxs)("div",{className:"h-[250px] w-full",children:[(0,l.jsx)(u.ll,{className:"mb-4 text-xl",children:"Biểu đồ Lịch sử điểm"}),(0,l.jsx)(m.h,{children:(0,l.jsxs)(h.w,{data:W,margin:{top:5,right:20,left:-10,bottom:5},children:[(0,l.jsx)(x.q,{strokeDasharray:"3 3"}),(0,l.jsx)(p.K,{dataKey:"week",tickFormatter:e=>"T".concat(e)}),(0,l.jsx)(f.B,{domain:[G.min,G.max],allowDecimals:!1}),(0,l.jsx)(j.u,{formatter:(e,t)=>null===e?["Chưa c\xf3 dữ liệu",t]:["".concat(e," điểm"),t],labelFormatter:e=>"Tuần ".concat(e)}),(0,l.jsx)(v.x,{connectNulls:!0,type:"monotone",dataKey:"points",stroke:"#8884d8",strokeWidth:2})]})})]})]})})]}),"all"!==z&&!P&&!_&&(0,l.jsxs)(u.Zb,{children:[(0,l.jsxs)(u.Ol,{children:[(0,l.jsxs)(u.ll,{children:["Danh S\xe1ch Vi Phạm (Tuần ",K,")"]}),(0,l.jsxs)(u.SZ,{children:["Lớp ",(0,l.jsx)("span",{className:"font-bold",children:null==V?void 0:V.name})]})]}),(0,l.jsx)(u.aY,{children:0===k.length?(0,l.jsx)("div",{className:"text-center py-10 text-gray-500",children:"Kh\xf4ng c\xf3 vi phạm n\xe0o."}):(0,l.jsx)("div",{className:"overflow-x-auto rounded-md border",children:(0,l.jsxs)(c.iA,{children:[(0,l.jsx)(c.xD,{children:(0,l.jsxs)(c.SC,{children:[(0,l.jsx)(c.ss,{children:"STT"}),(0,l.jsx)(c.ss,{children:"Thời gian"}),(0,l.jsx)(c.ss,{children:"Họ v\xe0 t\xean"}),(0,l.jsx)(c.ss,{children:"Nội dung"}),(0,l.jsx)(c.ss,{className:"text-center",children:"Điểm"}),(0,l.jsx)(c.ss,{className:"text-right",children:"H\xe0nh động"})]})}),(0,l.jsx)(c.RM,{children:k.map((e,t)=>{var s;return(0,l.jsxs)(c.SC,{children:[(0,l.jsx)(c.pj,{children:t+1}),(0,l.jsx)(c.pj,{children:(null===(s=e.recordDate)||void 0===s?void 0:s.seconds)?new Date(1e3*e.recordDate.seconds).toLocaleString("vi-VN",{timeZone:"Asia/Ho_Chi_Minh",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).replace(",",""):"N/A"}),(0,l.jsx)(c.pj,{className:"font-medium",children:e.studentName}),(0,l.jsxs)(c.pj,{children:[(0,l.jsx)("div",{children:y(e.ruleRef,A)}),(0,l.jsxs)("div",{className:"text-xs text-gray-500",children:["Người ghi nhận: ",C(e.supervisorRef,E)]})]}),(0,l.jsx)(c.pj,{className:"text-center font-semibold",children:(0,l.jsxs)("span",{className:(e.pointsApplied||0)>0?"text-green-600":0>(e.pointsApplied||0)?"text-red-600":"text-gray-500",children:[(e.pointsApplied||0)>0?"+":"",e.pointsApplied||0]})}),(0,l.jsx)(c.pj,{className:"text-right",children:e.studentId?(0,l.jsx)(a.default,{href:"/hoc-sinh/".concat(e.studentId),passHref:!0,children:(0,l.jsx)(d.z,{variant:"outline",size:"sm",children:"Chi tiết"})}):(0,l.jsx)(d.z,{variant:"outline",size:"sm",disabled:!0,children:"Chi tiết"})})]},e.id)})})]})})})]})]})}}},function(e){e.O(0,[6415,5117,2997,1661,6951,8146,8534,7364,6807,1293,1528,1744],function(){return e(e.s=62382)}),_N_E=e.O()}]);