(()=>{var e={};e.id=495,e.ids=[495],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},35816:e=>{"use strict";e.exports=require("process")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},7103:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>l.a,__next_app__:()=>p,originalPathname:()=>u,pages:()=>d,routeModule:()=>m,tree:()=>c}),s(63165),s(53012),s(87824),s(77718);var r=s(93282),a=s(5736),n=s(93906),l=s.n(n),i=s(36880),o={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>i[e]);s.d(t,o);let c=["",{children:["(admin)",{children:["reports",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,63165)),"/home/user/studio/apps/web/src/app/(admin)/reports/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,53012)),"/home/user/studio/apps/web/src/app/(admin)/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,87824,23)),"next/dist/client/components/not-found-error"]}]},{layout:[()=>Promise.resolve().then(s.bind(s,77718)),"/home/user/studio/apps/web/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,87824,23)),"next/dist/client/components/not-found-error"]}],d=["/home/user/studio/apps/web/src/app/(admin)/reports/page.tsx"],u="/(admin)/reports/page",p={require:s,loadChunk:()=>Promise.resolve()},m=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/(admin)/reports/page",pathname:"/reports",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},21040:(e,t,s)=>{Promise.resolve().then(s.bind(s,71665))},62960:(e,t,s)=>{Promise.resolve().then(s.bind(s,34896))},71665:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var r=s(73227),a=s(23677),n=s(87030),l=s(21449),i=s(49543),o=s(11250),c=s(49366);let d=new Date(new Date().getFullYear(),8,8),u=e=>{let t=new Date(e);return t.setHours(0,0,0,0),t},p=[{name:"Khối 6",classes:["6/1","6/2","6/3","6/4","6/5","6/6","6/7","6/8","6/9","6/10"]},{name:"Khối 7",classes:["7/1","7/2","7/3","7/4","7/5","7/6","7/7","7/8"]},{name:"Khối 8",classes:["8/1","8/2","8/3","8/4","8/5","8/6","8/7"]},{name:"Khối 9",classes:["9/1","9/2","9/3","9/4","9/5","9/6","9/7","9/8"]}];p.flatMap(e=>e.classes);let m=(()=>{let e=[];for(let t=1;t<=35;t++){let s=new Date(u(d).getTime()+(t-1)*6048e5),r=new Date(s.getTime()+5184e5),a=e=>e<10?`0${e}`:`${e}`;e.push({weekNumber:t,label:`Tuần ${t}`,dateRange:`(${a(s.getDate())}/${a(s.getMonth()+1)} - ${a(r.getDate())}/${a(r.getMonth()+1)})`})}return e})();function h(){let{toast:e}=(0,c.pm)(),[t,s]=(0,a.useState)([]),[d,u]=(0,a.useState)(!0),[h,x]=(0,a.useState)(!1),[g,f]=(0,a.useState)(null),[b,j]=(0,a.useState)("Khối 6"),v=async()=>{if(confirm("Bạn c\xf3 chắc muốn chạy quy tr\xecnh tổng hợp b\xe1o c\xe1o kh\xf4ng? Việc n\xe0y sẽ đọc to\xe0n bộ dữ liệu điểm v\xe0 ghi đ\xe8 b\xe1o c\xe1o cũ.")){x(!0),e({title:"Bắt đầu tổng hợp...",description:"Qu\xe1 tr\xecnh c\xf3 thể mất một v\xe0i ph\xfat. Vui l\xf2ng kh\xf4ng rời khỏi trang."});try{let t=(0,n.PL)((0,n.hJ)(l.db,"records")),s=(0,n.PL)((0,n.hJ)(l.db,"weeklyScores")),[r,a]=await Promise.all([t,s]),i=r.docs.map(e=>e.data()),o=a.docs.map(e=>e.data()),c={};for(let e=1;e<=35;e++)for(let t of(c[e]={},p)){let s="Khối 9"===t.name?330:340;for(let r of t.classes){let t=`class_${r.replace("/","_")}`,a=o.find(s=>s.week===e&&s.classId===t),n=a?.scores||{},l=i.filter(t=>t.week===e&&t.className===r),d=0,u=0;l.forEach(e=>{let t=Number(e.pointsApplied||0);"merit"===e.type?d+=t:"demerit"===e.type&&(u+=Math.abs(t))});let p=n.hoc_tap??s,m=n.ky_luat??s,h=n.ve_sinh??s,x=p+m+h+d-u;c[e][r]=x}}let d=(0,n.qs)(l.db);for(let e in c){let t=(0,n.JU)(l.db,"weekly_reports",`week_${e}`);d.set(t,{weekNumber:Number(e),scores:c[e]})}await d.commit(),e({title:"Th\xe0nh c\xf4ng!",description:`Đ\xe3 tổng hợp v\xe0 lưu b\xe1o c\xe1o cho 35 tuần. Dữ liệu sẽ tự động hiển thị.`})}catch(t){console.error("Lỗi khi tổng hợp b\xe1o c\xe1o:",t),e({variant:"destructive",title:"Đ\xe3 xảy ra lỗi!",description:"Kh\xf4ng thể ho\xe0n tất qu\xe1 tr\xecnh tổng hợp. Vui l\xf2ng kiểm tra console."})}finally{x(!1)}}},y=(0,a.useMemo)(()=>p.find(e=>e.name===b)?.classes||[],[b]),N=(0,a.useMemo)(()=>{let e=new Map;return t.forEach(t=>{e.set(t.weekNumber,t.scores)}),e},[t]);return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start",children:[(0,r.jsxs)("div",{children:[r.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"B\xe1o c\xe1o Tổng điểm Thi đua theo Tuần"}),r.jsx("p",{className:"text-muted-foreground mt-1",children:"Bảng tổng hợp điểm thi đua h\xe0ng tuần của tất cả c\xe1c lớp trong năm học."})]}),r.jsx(o.z,{onClick:v,disabled:h,children:h?"Đang xử l\xfd...":"Tổng hợp & Cập nhật B\xe1o c\xe1o"})]}),(0,r.jsxs)("div",{className:"flex items-center space-x-4 bg-card p-4 rounded-lg border",children:[r.jsx("label",{htmlFor:"grade-select",className:"font-medium",children:"Chọn khối để hiển thị:"}),r.jsx("select",{id:"grade-select",value:b,onChange:e=>j(e.target.value),className:"border rounded px-3 py-2 bg-background shadow-sm",children:p.map(e=>r.jsx("option",{value:e.name,children:e.name},e.name))})]}),r.jsx("div",{className:"rounded-lg border overflow-hidden bg-card",children:r.jsx("div",{className:"overflow-x-auto relative max-h-[70vh]",children:(0,r.jsxs)(i.iA,{className:"min-w-full border-collapse",children:[r.jsx(i.xD,{className:"bg-muted/50 sticky top-0 z-10",children:(0,r.jsxs)(i.SC,{children:[r.jsx(i.ss,{className:"font-bold w-[200px] sticky left-0 bg-muted z-20 shadow-sm",children:"Tuần"}),y.map(e=>r.jsx(i.ss,{className:"font-bold text-center min-w-[80px]",children:e},e))]})}),r.jsx(i.RM,{children:d&&!t.length?r.jsx(i.SC,{children:r.jsx(i.pj,{colSpan:y.length+1,className:"h-48 text-center",children:"Đang tải dữ liệu..."})}):g&&!t.length?r.jsx(i.SC,{children:r.jsx(i.pj,{colSpan:y.length+1,className:"h-48 text-center text-red-600",children:g})}):m.map(({weekNumber:e,label:t,dateRange:s})=>(0,r.jsxs)(i.SC,{className:"hover:bg-muted/30 group",children:[(0,r.jsxs)(i.pj,{className:"font-medium sticky left-0 bg-card group-hover:bg-muted/40 z-10 shadow-sm",children:[r.jsx("div",{className:"font-bold",children:t}),r.jsx("div",{className:"text-xs text-muted-foreground",children:s})]}),y.map(t=>{let s=N.get(e)?.[t];return r.jsx(i.pj,{className:"text-center font-semibold",children:"number"==typeof s?s:r.jsx("span",{className:"text-muted-foreground",children:"-"})},t)})]},e))})]})})}),r.jsx("div",{className:"p-px rounded-lg bg-gradient-to-r from-purple-400 via-pink-500 to-blue-500",children:(0,r.jsxs)("div",{className:"bg-white dark:bg-zinc-900 p-4 rounded-[7px]",children:[r.jsx("h4",{className:"font-bold",children:"Hướng dẫn"}),(0,r.jsxs)("p",{className:"text-sm mt-1",children:["Nhấn n\xfat ",r.jsx("strong",{children:'"Tổng hợp & Cập nhật B\xe1o c\xe1o"'})," để t\xednh to\xe1n v\xe0 lưu dữ liệu điểm tổng kết h\xe0ng tuần. Bảng sẽ tự động cập nhật sau khi qu\xe1 tr\xecnh ho\xe0n tất. Bạn n\xean chạy lại quy tr\xecnh n\xe0y khi c\xf3 sự thay đổi lớn về dữ liệu điểm."]})]})})]})}},34896:(e,t,s)=>{"use strict";s.d(t,{default:()=>l});var r=s(73227);s(23677);var a=s(41043),n=s(8313);function l({children:e}){let{user:t,loading:s,isSuperAdmin:l}=(0,n.a)();return((0,a.useRouter)(),s||!l)?r.jsx("div",{className:"flex h-screen items-center justify-center",children:r.jsx("p",{className:"text-sm text-muted-foreground",children:"Đang kiểm tra quyền truy cập..."})}):t&&l?r.jsx(r.Fragment,{children:e}):null}},49543:(e,t,s)=>{"use strict";s.d(t,{RM:()=>o,SC:()=>c,iA:()=>l,pj:()=>u,ss:()=>d,xD:()=>i});var r=s(73227),a=s(23677),n=s(18755);let l=a.forwardRef(({className:e,...t},s)=>r.jsx("div",{className:"relative w-full overflow-auto",children:r.jsx("table",{ref:s,className:(0,n.cn)("w-full caption-bottom text-sm",e),...t})}));l.displayName="Table";let i=a.forwardRef(({className:e,...t},s)=>r.jsx("thead",{ref:s,className:(0,n.cn)("[&_tr]:border-b",e),...t}));i.displayName="TableHeader";let o=a.forwardRef(({className:e,...t},s)=>r.jsx("tbody",{ref:s,className:(0,n.cn)("[&_tr:last-child]:border-0",e),...t}));o.displayName="TableBody",a.forwardRef(({className:e,...t},s)=>r.jsx("tfoot",{ref:s,className:(0,n.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",e),...t})).displayName="TableFooter";let c=a.forwardRef(({className:e,...t},s)=>r.jsx("tr",{ref:s,className:(0,n.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",e),...t}));c.displayName="TableRow";let d=a.forwardRef(({className:e,...t},s)=>r.jsx("th",{ref:s,className:(0,n.cn)("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",e),...t}));d.displayName="TableHead";let u=a.forwardRef(({className:e,...t},s)=>r.jsx("td",{ref:s,className:(0,n.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",e),...t}));u.displayName="TableCell",a.forwardRef(({className:e,...t},s)=>r.jsx("caption",{ref:s,className:(0,n.cn)("mt-4 text-sm text-muted-foreground",e),...t})).displayName="TableCaption"},21449:(e,t,s)=>{"use strict";s.d(t,{db:()=>c,l2:()=>o});var r=s(27992),a=s(17761),n=s(87030),l=s(53377),i=s(57237);s(42353);let o=(0,r.C6)().length?(0,r.Mq)():(0,r.ZF)({apiKey:"AIzaSyAqGxdFqDGXOiiKP5cKFvPkNkmTdY4aByw",authDomain:"app-quan-ly-hs.firebaseapp.com",projectId:"app-quan-ly-hs",storageBucket:"app-quan-ly-hs.appspot.com",messagingSenderId:"771200825229",appId:"1:771200825229:web:cbc5498073eff6be21afc4"});(0,a.v0)(o);let c=(0,n.ad)(o);(0,l.cF)(o),(0,i.$C)(o)},53012:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>n});var r=s(99013);let a=(0,s(53189).createProxy)(String.raw`/home/user/studio/apps/web/src/components/admin-guard.tsx#default`);function n({children:e}){return r.jsx(a,{children:e})}},63165:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>r});let r=(0,s(53189).createProxy)(String.raw`/home/user/studio/apps/web/src/app/(admin)/reports/page.tsx#default`)}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[142,202,184],()=>s(7103));module.exports=r})();