(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[547],{9979:function(e,t,a){Promise.resolve().then(a.bind(a,7981))},7981:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return N}});var l=a(7573),s=a(7653),n=a(6228),r=a(1245);let c=new Date(2025,8,8),o=e=>{let t=new Date(e);return t.setHours(0,0,0,0),t},d=e=>Math.max(1,Math.min(35,Math.floor(Math.floor((o(e instanceof Date?e:(null==e?void 0:e.toDate)?e.toDate():new Date(e)).getTime()-o(c).getTime())/864e5)/7)+1)),i=()=>{let e=[{value:"",label:"Tất cả c\xe1c tuần"}];for(let t=1;t<=35;t++){let a=new Date(o(c).getTime()+(t-1)*6048e5),l=new Date(a.getTime()+5184e5),s=e=>e<10?"0".concat(e):"".concat(e);e.push({value:String(t),label:"Tuần ".concat(t," (").concat(s(a.getDate()),"/").concat(s(a.getMonth()+1)," - ").concat(s(l.getDate()),"/").concat(s(l.getMonth()+1),")")})}return e},u=e=>{let t=e instanceof Date?e:(null==e?void 0:e.toDate)?e.toDate():new Date(e),a=e=>e<10?"0".concat(e):"".concat(e);return"".concat(t.getFullYear(),"-").concat(a(t.getMonth()+1),"-").concat(a(t.getDate()))},h=e=>{let t=e instanceof Date?e:(null==e?void 0:e.toDate)?e.toDate():new Date(e),a=e=>e<10?"0".concat(e):"".concat(e);return"".concat(a(t.getDate()),"/").concat(a(t.getMonth()+1),"/").concat(t.getFullYear())},m=e=>{if(!e)return"";let t=e.match(/class_(\d+)_/);return t?t[1]:""},p=e=>e&&e.startsWith("class_")?e.substring(6).replace(/_/g,"/"):e;function x(e){let{items:t,placeholder:a,value:n,onChange:r}=e,[c,o]=(0,s.useState)(!1),[d,i]=(0,s.useState)(""),u=(0,s.useRef)(null),h=(0,s.useMemo)(()=>{if(!d.trim())return t;let e=d.toLowerCase();return t.filter(t=>{var a,l;return t.label.toLowerCase().includes(e)||null!==(l=null===(a=t.sub)||void 0===a?void 0:a.toLowerCase().includes(e))&&void 0!==l&&l})},[t,d]),m=(0,s.useMemo)(()=>{var e;return(null===(e=t.find(e=>e.value===n))||void 0===e?void 0:e.label)||""},[t,n]);return(0,s.useEffect)(()=>{c&&u.current&&u.current.focus()},[c]),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsxs)("button",{type:"button",className:"w-full border rounded px-3 py-2 text-left bg-white text-base",onClick:()=>o(e=>!e),children:[(0,l.jsx)("span",{className:"truncate block",children:m||a}),(0,l.jsx)("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 opacity-60",children:"▾"})]}),c&&(0,l.jsxs)("div",{className:"absolute z-50 mt-1 w-full bg-white border rounded shadow-lg max-h-72 overflow-auto",children:[(0,l.jsx)("div",{className:"sticky top-0 bg-white p-2 border-b",children:(0,l.jsx)("input",{ref:u,value:d,onChange:e=>i(e.target.value),placeholder:"T\xecm kiếm nhanh...",className:"w-full border rounded px-3 py-2 text-base"})}),0===h.length?(0,l.jsx)("div",{className:"p-3 text-gray-500",children:"Kh\xf4ng c\xf3 kết quả"}):h.map(e=>(0,l.jsxs)("div",{className:"px-4 py-2 cursor-pointer hover:bg-gray-100",onClick:()=>{r(e.value),o(!1),i("")},children:[(0,l.jsx)("div",{className:"font-medium text-base",children:e.label}),e.sub&&(0,l.jsx)("div",{className:"text-sm text-gray-500",children:e.sub})]},e.value))]})]})}let b=new Set(["D06","C11"]),g="special:",f="".concat(g,"tap-the-lop"),v="".concat(g,"lop-truong"),y="".concat(g,"to-truc");function N(){let[e,t]=(0,s.useState)(!0),[a,c]=(0,s.useState)(null),[o,N]=(0,s.useState)([]),[j,w]=(0,s.useState)([]),[k,D]=(0,s.useState)([]),[C,S]=(0,s.useState)(""),[R,T]=(0,s.useState)(""),[A,M]=(0,s.useState)(""),[I,L]=(0,s.useState)(""),[q,_]=(0,s.useState)(new Date),[E,K]=(0,s.useState)(""),[J,B]=(0,s.useState)(""),[F,P]=(0,s.useState)(1),[X,V]=(0,s.useState)([]);(0,s.useEffect)(()=>{let e=[(0,n.cf)((0,n.hJ)(r.db,"students"),e=>N(e.docs.map(e=>({id:e.id,...e.data()}))),e=>c("Kh\xf4ng thể tải danh s\xe1ch học sinh.")),(0,n.cf)((0,n.hJ)(r.db,"rules"),e=>w(e.docs.map(e=>({id:e.id,...e.data()}))),e=>c("Kh\xf4ng thể tải danh s\xe1ch quy định.")),(0,n.cf)((0,n.IO)((0,n.hJ)(r.db,"records"),(0,n.Xo)("createdAt","desc")),e=>D(e.docs.map(e=>({id:e.id,...e.data()}))),e=>c("Kh\xf4ng thể tải c\xe1c ghi nhận đ\xe3 lưu."))];return Promise.all([new Promise(e=>(0,n.cf)((0,n.hJ)(r.db,"students"),e)),new Promise(e=>(0,n.cf)((0,n.hJ)(r.db,"rules"),e)),new Promise(e=>(0,n.cf)((0,n.IO)((0,n.hJ)(r.db,"records"),(0,n.Xo)("createdAt","desc")),e))]).then(()=>t(!1)),()=>e.forEach(e=>e())},[]);let H=(0,s.useMemo)(i,[]),O=(0,s.useMemo)(()=>[{value:"",label:"Tất cả c\xe1c khối"},...Array.from(new Set(o.map(e=>m(e.classRef)).filter(Boolean))).sort((e,t)=>parseInt(e)-parseInt(t)).map(e=>({value:e,label:"Khối ".concat(e)}))],[o]),U=(0,s.useMemo)(()=>{let e=new Intl.Collator("vi",{numeric:!0,sensitivity:"base"}),t=Array.from(new Set(o.map(e=>e.classRef).filter(Boolean)));return R&&(t=t.filter(e=>m(e)===R)),t.sort(e.compare),[{value:"",label:"Tất cả c\xe1c lớp"},...t.map(e=>({value:e,label:p(e)}))]},[o,R]),W=(0,s.useMemo)(()=>{let e=o.filter(e=>!A||e.classRef===A).map(e=>({value:e.id,label:e.fullName,sub:"".concat(p(e.classRef)," - ").concat(e.schoolId)})).sort((e,t)=>e.label.localeCompare(t.label,"vi"));if(A){let t=p(A);return[{value:f,label:"Tập thể lớp ".concat(t),sub:"\xc1p dụng cho cả lớp"},{value:v,label:"Lớp trưởng ".concat(t),sub:"\xc1p dụng cho lớp trưởng"},{value:y,label:"Tổ trực ".concat(t),sub:"\xc1p dụng cho tổ trực"},...e]}return e},[o,A]),G=(0,s.useMemo)(()=>j.map(e=>({value:e.code,label:"".concat(e.code," — ").concat(e.description),sub:"".concat("merit"===e.type?"":" ").concat(e.points," điểm")})),[j]),Y=(0,s.useMemo)(()=>b.has(J),[J]);async function z(){var e;if(0===X.length)return;let t=(0,n.qs)(r.db),a=(0,n.hJ)(r.db,"records"),l=(null===r.I8||void 0===r.I8?void 0:null===(e=r.I8.currentUser)||void 0===e?void 0:e.uid)||null;X.forEach(e=>{t.set((0,n.JU)(a),{className:e.className,classRef:e.classRef,createdAt:(0,n.Bt)(),pointsApplied:e.pointsApplied,quantity:e.quantity,recordDate:e.recordDate,ruleRef:e.ruleCode,studentName:e.studentName,studentRef:e.studentId,supervisorRef:l,type:e.type,week:e.week})});try{await t.commit(),V([]),alert("Đ\xe3 lưu th\xe0nh c\xf4ng ".concat(X.length," mục."))}catch(e){console.error("Lỗi khi lưu:",e),alert("Đ\xe3 xảy ra lỗi khi lưu c\xe1c mục. Vui l\xf2ng thử lại.")}}async function Q(e){if(window.confirm("Bạn c\xf3 chắc chắn muốn xo\xe1 mục n\xe0y kh\xf4ng? H\xe0nh động n\xe0y kh\xf4ng thể ho\xe0n t\xe1c."))try{await (0,n.oe)((0,n.JU)(r.db,"records",e))}catch(e){console.error("Lỗi khi xo\xe1:",e),alert("Đ\xe3 xảy ra lỗi khi xo\xe1. Vui l\xf2ng thử lại.")}}let Z=(0,s.useMemo)(()=>{let e=k;if(C&&(e=e.filter(e=>String(e.week||d(e.recordDate))===String(C))),R&&(e=e.filter(e=>e.classRef&&m(e.classRef)===R)),A&&(e=e.filter(e=>e.classRef===A)),I){let t=I.toLowerCase();e=e.filter(e=>{var a;return String(e.studentName||"").toLowerCase().includes(t)||String(e.ruleRef||"").toLowerCase().includes(t)||String((null===(a=j.find(t=>t.code===e.ruleRef))||void 0===a?void 0:a.description)||"").toLowerCase().includes(t)||String(e.className||"").toLowerCase().includes(t)})}return e},[k,C,R,A,I,j]);return e?(0,l.jsx)("div",{className:"p-8 text-center text-xl",children:"Đang tải dữ liệu, vui l\xf2ng chờ..."}):a?(0,l.jsx)("div",{className:"p-8 text-center text-red-600 bg-red-50 rounded-lg",children:a}):(0,l.jsxs)("div",{className:"p-4 md:p-6 lg:p-8 max-w-7xl mx-auto space-y-6",children:[(0,l.jsxs)("div",{className:"bg-white p-5 rounded-lg shadow-md",children:[(0,l.jsx)("h2",{className:"font-bold text-xl mb-4",children:"Bộ lọc v\xe0 C\xf4ng cụ"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4 items-end",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-gray-700 text-sm mb-1 font-medium",children:"Tuần"}),(0,l.jsx)("select",{className:"border rounded px-3 py-2 w-full text-base",value:C,onChange:e=>S(e.target.value),children:H.map(e=>(0,l.jsx)("option",{value:e.value,children:e.label},e.label))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-gray-700 text-sm mb-1 font-medium",children:"Khối"}),(0,l.jsx)("select",{className:"border rounded px-3 py-2 w-full text-base",value:R,onChange:e=>{T(e.target.value),M("")},children:O.map(e=>(0,l.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-gray-700 text-sm mb-1 font-medium",children:"Lớp"}),(0,l.jsx)("select",{className:"border rounded px-3 py-2 w-full text-base",value:A,onChange:e=>{M(e.target.value),K("")},children:U.map(e=>(0,l.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,l.jsxs)("div",{className:"md:col-span-2",children:[(0,l.jsx)("label",{className:"block text-gray-700 text-sm mb-1 font-medium",children:"T\xecm kiếm"}),(0,l.jsx)("input",{className:"border rounded px-3 py-2 w-full text-base",value:I,onChange:e=>L(e.target.value),placeholder:"T\xean học sinh, nội dung, m\xe3 lớp...",type:"search"})]})]})]}),(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-5",children:[(0,l.jsx)("h2",{className:"font-bold text-xl mb-4",children:"Th\xeam Ghi Nhận Mới"}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 items-end gap-4",children:[(0,l.jsxs)("div",{className:"md:col-span-1",children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Đối tượng"}),(0,l.jsx)(x,{items:W,placeholder:A?"Chọn đối tượng...":"Vui l\xf2ng chọn lớp trước",value:E,onChange:K})]}),(0,l.jsxs)("div",{className:"md:col-span-1",children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Quy định"}),(0,l.jsx)(x,{items:G,placeholder:"Chọn quy định...",value:J,onChange:B})]}),(0,l.jsxs)("div",{className:"transition-all duration-300 ".concat(Y?"opacity-100":"opacity-0 pointer-events-none"),children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Số lượng"}),(0,l.jsx)("input",{className:"border rounded px-3 py-2 w-full text-base",type:"number",value:F,onChange:e=>P(Math.max(1,parseInt(e.target.value,10))),min:"1"})]}),(0,l.jsxs)("div",{className:"flex items-end gap-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ng\xe0y ghi nhận"}),(0,l.jsx)("input",{className:"border rounded px-3 py-2 bg-white text-base",type:"date",value:u(q),onChange:e=>_(new Date(e.target.value))})]}),(0,l.jsx)("button",{className:"px-5 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 font-semibold text-base",onClick:function(){let e;if(!E||!J||!q){alert("Vui l\xf2ng nhập đủ Học sinh, Quy định v\xe0 Ng\xe0y ghi nhận.");return}if(E.startsWith(g)&&!A){alert("Vui l\xf2ng chọn một lớp cụ thể trong bộ lọc để \xe1p dụng cho tập thể.");return}let t=j.find(e=>e.code===J);if(!t){alert("Quy định kh\xf4ng hợp lệ!");return}let a=0;if("demerit"===t.type){let e=function(e){let{studentId:t,ruleCode:a,recordDate:l}=e,s=d(l),n=0,r=t.startsWith(g)?"".concat(t,"|").concat(A):t;return k.forEach(e=>{var t;let l=(null===(t=e.recordDate)||void 0===t?void 0:t.toDate)?e.recordDate.toDate():new Date;e.studentRef===r&&e.ruleRef===a&&d(l)===s&&n++}),X.forEach(e=>{e.studentId===r&&e.ruleCode===a&&e.week===s&&n++}),n+1}({studentId:E,ruleCode:J,recordDate:q});a=-(Math.abs(Number(t.points))*e)}else a=Number(t.points)*(Y?F:1);if(E.startsWith(g)){let t=p(A),a="";E===f?a="Tập thể lớp ".concat(t):E===v?a="Lớp trưởng ".concat(t):E===y&&(a="Tổ trực ".concat(t)),e={id:"".concat(E,"|").concat(A),name:a,classRef:A,className:t}}else{let t=o.find(e=>e.id===E);if(!t){alert("Học sinh kh\xf4ng hợp lệ!");return}e={id:t.id,name:t.fullName,classRef:t.classRef,className:p(t.classRef)}}V(l=>[{id:crypto.randomUUID(),studentId:e.id,studentName:e.name,classRef:e.classRef,className:e.className,ruleCode:t.code,ruleDesc:t.description,type:t.type,pointsApplied:a,recordDate:q,week:d(q),quantity:Y?F:1,_status:"pending"},...l]),K("")},disabled:!E||!J,children:"Th\xeam"})]})]})]}),(0,l.jsxs)("div",{className:"bg-white rounded-lg shadow-md",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,l.jsx)("h2",{className:"font-bold text-xl",children:"Danh s\xe1ch Ghi nhận"}),(0,l.jsxs)("button",{className:"px-4 py-2 rounded text-white font-semibold ".concat(0===X.length?"bg-gray-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700"),disabled:0===X.length,onClick:z,children:["Lưu Tất Cả (",X.length,")"]})]}),(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"min-w-full border-collapse text-base",children:[(0,l.jsx)("thead",{className:"bg-gray-100",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"px-3 py-3 border-b text-left font-semibold",children:"Ng\xe0y"}),(0,l.jsx)("th",{className:"px-3 py-3 border-b text-left font-semibold",children:"Tuần"}),(0,l.jsx)("th",{className:"px-3 py-3 border-b text-left font-semibold",children:"Lớp"}),(0,l.jsx)("th",{className:"px-3 py-3 border-b text-left font-semibold",children:"Đối tượng"}),(0,l.jsx)("th",{className:"px-3 py-3 border-b text-left font-semibold",children:"Nội dung"}),(0,l.jsx)("th",{className:"px-3 py-3 border-b font-semibold text-center",children:"Điểm"}),(0,l.jsx)("th",{className:"px-3 py-3 border-b font-semibold text-center",children:"H\xe0nh động"})]})}),(0,l.jsxs)("tbody",{children:[X.map((e,t)=>(0,l.jsxs)("tr",{className:"bg-yellow-50 hover:bg-yellow-100",children:[(0,l.jsx)("td",{className:"border-b px-3 py-2",children:h(e.recordDate)}),(0,l.jsx)("td",{className:"border-b px-3 py-2 text-center",children:e.week}),(0,l.jsx)("td",{className:"border-b px-3 py-2",children:e.className}),(0,l.jsx)("td",{className:"border-b px-3 py-2 font-semibold",children:e.studentName}),(0,l.jsxs)("td",{className:"border-b px-3 py-2",children:[e.ruleDesc," ",e.quantity>1?"(SL: ".concat(e.quantity,")"):""]}),(0,l.jsx)("td",{className:"border-b px-3 py-2 text-center font-bold",children:(0,l.jsxs)("span",{className:e.pointsApplied>0?"text-green-600":"text-red-600",children:[e.pointsApplied>0?"+":"",e.pointsApplied]})}),(0,l.jsx)("td",{className:"border-b px-3 py-2 text-center",children:(0,l.jsx)("button",{className:"text-red-500 hover:underline",onClick:()=>{var t;return t=e.id,void V(e=>e.filter(e=>e.id!==t))},children:"Xo\xe1"})})]},e.id)),Z.map((e,t)=>{var a,s;return(0,l.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,l.jsx)("td",{className:"border-b px-3 py-2",children:h(e.recordDate)}),(0,l.jsx)("td",{className:"border-b px-3 py-2 text-center",children:null!==(s=e.week)&&void 0!==s?s:"..."}),(0,l.jsx)("td",{className:"border-b px-3 py-2",children:e.className}),(0,l.jsx)("td",{className:"border-b px-3 py-2 font-semibold",children:e.studentName}),(0,l.jsxs)("td",{className:"border-b px-3 py-2",children:[(null===(a=j.find(t=>t.code===e.ruleRef))||void 0===a?void 0:a.description)||e.ruleRef," ",e.quantity>1?"(SL: ".concat(e.quantity,")"):""]}),(0,l.jsx)("td",{className:"border-b px-3 py-2 text-center font-bold",children:(0,l.jsxs)("span",{className:e.pointsApplied>0?"text-green-600":"text-red-600",children:[e.pointsApplied>0?"+":"",e.pointsApplied]})}),(0,l.jsx)("td",{className:"border-b px-3 py-2 text-center",children:(0,l.jsx)("button",{className:"text-red-500 hover:underline",onClick:()=>Q(e.id),children:"Xo\xe1"})})]},e.id)}),X.length+Z.length===0&&(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:7,className:"text-center text-gray-500 py-10 text-lg",children:"Kh\xf4ng c\xf3 ghi nhận n\xe0o."})})]})]})})]})]})}},1245:function(e,t,a){"use strict";a.d(t,{l2:function(){return d},I8:function(){return i},db:function(){return u}});var l=a(8531),s=a(1523),n=a(6228),r=a(2615),c=a(1913),o=a(2149);let d=(0,l.C6)().length?(0,l.Mq)():(0,l.ZF)({apiKey:"AIzaSyAqGxdFqDGXOiiKP5cKFvPkNkmTdY4aByw",authDomain:"app-quan-ly-hs.firebaseapp.com",projectId:"app-quan-ly-hs",storageBucket:"app-quan-ly-hs.appspot.com",messagingSenderId:"771200825229",appId:"1:771200825229:web:cbc5498073eff6be21afc4"});(0,o.yu)(d,{provider:new o.z9("6Lf-0_gpAAAAAB6_ZgV7e_FvX8xw_9x3X_yYjW4C"),isTokenAutoRefreshEnabled:!0});let i=(0,s.v0)(d),u=(0,n.ad)(d);(0,r.cF)(d),(0,c.$C)(d)}},function(e){e.O(0,[415,5,460,192,293,528,744],function(){return e(e.s=9979)}),_N_E=e.O()}]);